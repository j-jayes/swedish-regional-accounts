---
title: "Swedish regional accounts"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: flatly
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggiraph)
library(glue)
library(scales)
library(shiny)
library(cowplot)
library(sf)


df <- read_rds("data/data-cleaned/df.rds")
```

# Labour force

```{r}
selectizeInput("sector_c1", label = "Sector",
            choices = c("Agriculture", "Manufacturing", "Mining"), 
            selected = "Agriculture",
            multiple = F)

renderGirafe({
  gg <- df %>%
    filter(
      series == "Labour force shares in the Swedish counties",
      subset == input$sector_c1,
      year != 1769
    ) %>%
    ggplot(aes(year, value, color = lan)) +
    geom_line_interactive(aes(tooltip = lan, data_id = lan)) +
    scale_y_continuous(labels = percent_format()) +
    scale_color_viridis_d() +
    theme(legend.position = "none") +
    labs(
      y = glue("Share of labour force in {input$sector_c1}"),
      x = NULL
    )


  x <- girafe(
    ggobj = gg, width_svg = 8, height_svg = 6,
    options = list(
      opts_hover_inv(css = "opacity:0.1;"),
      opts_hover(css = "stroke-width:2;")
    )
  )

  x
})

```

===========================

# GDP

```{r}
renderGirafe({
  lan_map <- st_read("data/county-shapefiles/maps/sverige-lan-counties-of-sweden.shp") %>%
    rename(lan = lan_namn)

  s_map <- lan_map %>%
    mutate( # JavaScript call to open website
      onclick = glue::glue(
        'window.open("https://en.wikipedia.org/wiki/{lan}")'
      )
    ) %>%
    ggplot() +
    geom_sf_interactive(
      aes(
        data_id = lan,
        tooltip = lan,
        onclick = onclick
      )
    ) +
    theme_void()

  gg <- df %>%
    filter(series == "GDP per capita in the Swedish counties (1750-1850, Sweden=100)") %>%
    ggplot(aes(year, value, color = lan)) +
    geom_line_interactive(aes(tooltip = lan, data_id = lan)) +
    scale_y_continuous(labels = number_format()) +
    scale_color_viridis_d() +
    theme(legend.position = "none") +
    labs(
      y = "GDP per capita (Sweden 1750 = 100)",
      x = NULL
    )

  int_fig <- girafe(
    ggobj = plot_grid(gg, s_map, rel_widths = c(4, 1), ncol = 2),
    width_svg = 5,
    height_svg = 3,
    options = list(
      # opts_tooltip(css = tooltip_css, delay_mouseover = 0, delay_mouseout = 0),
      opts_hover_inv(css = "opacity:0.1;"),
      opts_hover(css = "stroke-width:2;")
    )
  )

  int_fig
})
```

===========================

# GDP slider input

```{r}

sliderInput("year_c3", label = "Year:",
            min = 1750, max = 1850, value = 1750, step = 10)

renderGirafe({
  lan_map <- st_read("data/county-shapefiles/maps/sverige-lan-counties-of-sweden.shp") %>%
    rename(lan = lan_namn)

  s_map_2 <- lan_map %>%
    inner_join(df %>% filter(
      series == "Shares of total GDP in the Swedish counties (1750-1850)",
      year == input$year_c3
    )) %>%
    mutate( # JavaScript call to open website
      onclick = glue::glue(
        'window.open("https://en.wikipedia.org/wiki/{lan}")'
      )
    ) %>%
    ggplot() +
    geom_sf_interactive(
      aes(
        fill = value,
        data_id = lan,
        tooltip = lan,
        onclick = onclick
      )
    ) +
    scale_fill_gradient2_interactive(
      low = "blue",
      high = "red",
      mid = "pink",
      midpoint = 0.06,
      labels = percent_format()
    ) +
    labs(fill = glue("Share of GDP in {input$year_c3}")) +
    theme_void()


  girafe(
    ggobj = s_map_2,
    width_svg = 6,
    height_svg = 6 * 0.618
  )
})
```

